<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Macho Hat Uploader</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Google APIs for Picker -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://apis.google.com/js/api/picker.js"></script>
  <style>
    body {
      background: #1a1a22;
      color: #fff;
      width: 320px;
      font-family: sans-serif;
      padding: 24px 0 12px 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh; /* Ensures content is centered vertically */
      box-sizing: border-box; /* Include padding in width/height */
    }
    #hat-img {
      display: block;
      margin: 0 auto 20px auto;
      width: 72px;
      height: 72px;
      border-radius: 50%;
      border: 2px solid #fff;
      background: #d00;
      box-shadow: 0 0 12px #222a;
    }
    .menu-btn {
      width: 90%;
      display: block;
      margin: 14px auto;
      font-size: 17px;
      padding: 14px 0;
      border: none;
      border-radius: 12px;
      background: #36364a;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.15s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3); /* Softer shadow */
    }
    .menu-btn:hover { background: #464666; }
    #status {
      margin-top: 12px;
      text-align: center;
      font-size: 14px;
      min-height: 20px;
      color: #91ffac; /* Default: green for status */
      word-break: break-word; /* Prevents overflow for long messages */
      padding: 0 10px; /* Add some padding */
    }
    #status.error {
        color: #ff6b6b; /* Red for error messages */
    }
  </style>
</head>
<body>
  <img src="https://raw.githubusercontent.com/sawicki456/mmm-index/refs/heads/main/hat.png" id="hat-img" alt="Macho Hat">
  <button class="menu-btn" id="pick-folder-btn">Upload Art to Any Folder</button>
  <button class="menu-btn" id="trigger-index-btn">Trigger Index Update</button>
  <button class="menu-btn" id="reminder-btn">Copy Consistency Reminder</button>
  <div id="status"></div>

  <script>
    // --- CONFIGURATION ---
    const CLIENT_ID = '705073291364-vepbigh687lpkg1qjosupk9961nbnagd.apps.googleusercontent.com';
    const DEVELOPER_KEY = 'AIzaSyCbNx0M5dMLY-51grw45LJRLjfC_f8eniA';
    const APP_ID = '705073291364'; 
    const ROOT_FOLDER_ID = '135BPvCXeRAXDOEMAlenWzoicRmtn_e_7';
    const SCOPE = 'https://www.googleapis.com/auth/drive'; 
    const INDEX_TRIGGER_URL = 'https://script.google.com/macros/s/AKfycbx_ViRshOUP8y3eR-RbQDX9o2nEGvP7_vLdW_GPLnGE0cdv1jcCU9us7DxUAOO1Fc5N_w/exec';

    // --- State Variables ---
    let accessToken = null;
    let pickerInited = false;
    let driveClientLoaded = false; // NEW: Track if gapi.client.drive is loaded
    let tokenClient = null;

    // --- DOM Elements ---
    const uploadBtn = document.getElementById('pick-folder-btn');
    const triggerIndexBtn = document.getElementById('trigger-index-btn');
    const reminderBtn = document.getElementById('reminder-btn');
    const statusDiv = document.getElementById('status');

    // --- Helper for Status Messages ---
    function setStatus(msg, isError = false) {
      const now = new Date().toLocaleTimeString();
      statusDiv.innerText = `[${now}] ${msg}`;
      statusDiv.classList.toggle('error', isError); 
    }

    // --- Google API Loader Functions ---
    function ready(fn) {
      // Ensure all major Google API components are loaded
      if (window.google && window.google.picker && window.gapi && window.gapi.load && window.gapi.client) {
        fn();
      } else {
        setTimeout(() => ready(fn), 100); 
      }
    }

    // Loads the Google Picker API module
    function loadPickerApi() {
      gapi.load('picker', { callback: () => { pickerInited = true; } });
    }

    // Loads the Google Drive API client
    function loadDriveClient() {
      gapi.client.load('drive', 'v3').then(() => {
        driveClientLoaded = true;
      }).catch(e => {
        setStatus(`Failed to load Drive API client: ${e.message}`, true);
      });
    }

    // --- Main Initialization Logic (Runs when all APIs are ready) ---
    ready(() => {
      // Initialize Google Identity Services (GIS) token client for OAuth
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPE,
        callback: (tokenResponse) => {
          if (tokenResponse && tokenResponse.access_token) {
            accessToken = tokenResponse.access_token;
            setStatus("Google Drive session active. Ready for uploads.");
            showFolderPicker(); 
          } else {
            setStatus('Authentication failed. Please try again.', true);
          }
        },
      });

      // Load Google API client components
      gapi.load('client', { callback: loadPickerApi }); // loads gapi.client base
      gapi.load('client:drive', { callback: loadDriveClient }); // NEW: Explicitly load drive client


      // --- Event Listeners for Buttons ---

      // Upload Button: Initiates OAuth and then shows the folder picker
      uploadBtn.onclick = () => {
        setStatus('Initiating upload workflow...');
        if (!driveClientLoaded) { // Check if Drive client is loaded before proceeding
            setStatus('Drive API client not loaded yet. Please wait a moment and try again.', true);
            return;
        }
        if (accessToken) {
          showFolderPicker();
        } else {
          tokenClient.requestAccessToken();
        }
      };

      // Consistency Reminder Button: Copies text to clipboard
      reminderBtn.onclick = () => {
        const REMINDER_TEXT = `Review the latest project index and files before generating art or text. Use only canonical character, location, and object references from the index. Ensure all outputs are consistent with existing assets and do not invent or change any details without explicit instruction.`;
        navigator.clipboard.writeText(REMINDER_TEXT);
        setStatus("Reminder copied to clipboard!");
      };

      // Trigger Index Update Button: Calls Google Apps Script Web App
      triggerIndexBtn.onclick = () => {
        setStatus("Triggering index update, please wait...");
        fetch(INDEX_TRIGGER_URL, { method: "POST", mode: "no-cors" }) 
          .then(() => {
            setStatus("Index update triggered successfully!");
          })
          .catch((e) => {
            setStatus(`Error triggering index update: ${e.message}`, true);
          });
      };
    });

    // --- Google Picker Functions ---

    // Step 1: Show the Folder Picker dialog to select or create a target folder for upload
    function showFolderPicker() {
      if (!pickerInited || !accessToken) {
        setStatus('Google Picker or Access Token not ready. Please try again.', true);
        return;
      }

      const folderView = new google.picker.DocsView(google.picker.ViewId.FOLDERS)
        .setParent(ROOT_FOLDER_ID)
        .setIncludeFolders(true)
        .setSelectFolderEnabled(true); 
      
      const createFolderView = new google.picker.DocsCreateFolderView().setParent(ROOT_FOLDER_ID);

      const picker = new google.picker.PickerBuilder()
        .setOAuthToken(accessToken)
        .setDeveloperKey(DEVELOPER_KEY)
        .setAppId(APP_ID)
        .addView(folderView)
        .addView(createFolderView) 
        .setTitle('Select or Create a Folder for Upload') 
        .setCallback(folderPickerCallback)
        .build();
      picker.setVisible(true);
      setStatus('Choose a folder for your upload.');
    }

    // Callback after user picks or creates a folder
    function folderPickerCallback(data) {
      if (data.action === google.picker.Action.PICKED) {
        const folder = data.docs[0]; 
        setStatus(`Selected folder: ${folder.name}. Now pick file(s) to upload.`);
        promptFileUpload(folder.id); 
      } else if (data.action === google.picker.Action.CANCEL) {
        setStatus('Folder selection cancelled.', true);
      }
    }

    // Step 2: Prompt user to select file(s) and then handle the upload
    function promptFileUpload(folderId) {
      // Ensure drive client is loaded before using gapi.client.drive.files
      if (!driveClientLoaded) {
          setStatus('Drive API client not ready for upload. Please try again.', true);
          return;
      }

      const input = document.createElement('input');
      input.type = 'file';
      input.multiple = true; 
      input.accept = 'image/*,video/*,application/pdf,text/plain'; 
      input.onchange = async () => {
        const files = input.files; 
        if (files.length === 0) {
          setStatus('No files selected for upload.', true);
          return;
        }

        setStatus(`Uploading ${files.length} file(s) to selected folder...`);
        
        let uploadedCount = 0;
        let failedCount = 0;
        const uploadPromises = [];

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const originalFileName = file.name; 
          let newName = prompt(`Rename file ${i + 1}/${files.length} (${originalFileName}):`, originalFileName);
          if (!newName || newName.trim() === "") newName = originalFileName;

          const metadata = {
            name: newName,
            parents: [folderId],
            properties: { 
              originalFileName: originalFileName 
            }
          };

          const formData = new FormData();
          formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
          formData.append('file', file);

          const uploadPromise = fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
            body: formData,
          })
          .then(res => {
            if (!res.ok) {
              return res.text().then(text => Promise.reject(new Error(`HTTP error! status: ${res.status}, msg: ${text}`)));
            }
            return res.json();
          })
          .then(val => {
            uploadedCount++;
            setStatus(`Uploaded ${uploadedCount}/${files.length}: ${val.name}`);
          })
          .catch(e => {
            failedCount++;
            setStatus(`Failed to upload ${originalFileName}: ${e.message}`, true); 
          });
          uploadPromises.push(uploadPromise);
        }

        await Promise.allSettled(uploadPromises);
        setStatus(`Batch upload complete! ${uploadedCount} succeeded, ${failedCount} failed.`);
      };
      input.click(); 
    }
  </script>
</body>
</html>
