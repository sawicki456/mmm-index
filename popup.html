<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Macho Hat Uploader</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Google APIs for Picker -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://apis.google.com/js/api/picker.js"></script>
  <style>
    body { background: #1a1a22; color: #fff; width: 320px; font-family: sans-serif; padding: 24px 0 12px 0; margin: 0; }
    #hat-img { display: block; margin: 0 auto 20px auto; width: 72px; height: 72px; border-radius: 50%; border: 2px solid #fff; background: #d00; box-shadow: 0 0 12px #222a; }
    .menu-btn { width: 90%; display: block; margin: 14px auto; font-size: 17px; padding: 14px 0; border: none; border-radius: 12px; background: #36364a; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.15s; }
    .menu-btn:hover { background: #464666; }
    #status { margin-top: 12px; text-align: center; font-size: 14px; min-height: 20px; }
  </style>
</head>
<body>
  <img src="https://raw.githubusercontent.com/sawicki456/mmm-index/refs/heads/main/hat.png" id="hat-img" alt="Macho Hat">
  <button class="menu-btn" id="pick-folder-btn">Upload Art to Any Folder</button>
  <button class="menu-btn" id="trigger-index-btn">Trigger Index Update</button>
  <button class="menu-btn" id="reminder-btn">Copy Consistency Reminder</button>
  <div id="status"></div>
  <script>
    // --- CONFIGURATION ---
    const CLIENT_ID = '705073291364-vepbigh687lpkg1qjosupk9961nbnagd.apps.googleusercontent.com';
    const DEVELOPER_KEY = 'AIzaSyCbNx0M5dMLY-51grw45LJRLjfC_f8eniA';
    const APP_ID = '705073291364';
    const SCOPE = 'https://www.googleapis.com/auth/drive';
    const INDEX_TRIGGER_URL = 'https://script.google.com/macros/s/AKfycbx_ViRshOUP8y3eR-RbQDX9o2nEGvP7_vLdW_GPLnGE0cdv1jcCU9us7DxUAOO1Fc5N_w/exec';

    let accessToken = null;
    let pickerInited = false;
    let tokenClient = null;

    // Helper for status with timestamp
    function setStatus(msg) {
      const now = new Date().toLocaleString();
      document.getElementById('status').innerText = `[${now}] ${msg}`;
    }

    // Wait until all APIs are loaded (especially google.picker)
    function ready(fn) {
      if (window.google && window.google.picker && window.gapi && window.gapi.load) fn();
      else setTimeout(() => ready(fn), 100);
    }

    function loadPickerApi() {
      gapi.load('picker', {callback: () => { pickerInited = true; }});
    }

    ready(() => {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPE,
        callback: (tokenResponse) => {
          if (tokenResponse && tokenResponse.access_token) {
            accessToken = tokenResponse.access_token;
            showFolderPicker();
          }
        },
      });
      gapi.load('client', {callback: loadPickerApi});

      document.getElementById('pick-folder-btn').onclick = () => {
        setStatus('Loading folder picker...');
        if (accessToken) {
          showFolderPicker();
        } else {
          tokenClient.requestAccessToken();
        }
      };

      document.getElementById('reminder-btn').onclick = () => {
        const REMINDER = `Review the latest project index and files before generating art or text. Use only canonical character, location, and object references from the index. Ensure all outputs are consistent with existing assets and do not invent or change any details without explicit instruction.`;
        navigator.clipboard.writeText(REMINDER);
        setStatus("Reminder copied!");
      };

      document.getElementById('trigger-index-btn').onclick = () => {
        setStatus("Index update triggered, please wait...");
        fetch(INDEX_TRIGGER_URL, { method: "POST", mode: "no-cors" })
          .then(() => {
            setStatus("Index update triggered!");
          })
          .catch(() => {
            setStatus("Error triggering index update!");
          });
      };
    });

    // --- Google Picker Folder-Upload Logic ---
    function showFolderPicker() {
      if (!pickerInited || !accessToken) {
        setStatus('Google Picker not ready.');
        return;
      }
      const folderView = new google.picker.DocsView(google.picker.ViewId.FOLDERS)
        .setIncludeFolders(true)
        .setSelectFolderEnabled(true);
      const picker = new google.picker.PickerBuilder()
        .setOAuthToken(accessToken)
        .setDeveloperKey(DEVELOPER_KEY)
        .setAppId(APP_ID)
        .addView(folderView)
        .setCallback(folderPickerCallback)
        .build();
      picker.setVisible(true);
      setStatus('');
    }

    function folderPickerCallback(data) {
      if (data.action === google.picker.Action.PICKED) {
        const folder = data.docs[0];
        setStatus(`Selected folder: ${folder.name}`);
        promptFileUpload(folder.id);
      } else if (data.action === google.picker.Action.CANCEL) {
        setStatus('No folder selected.');
      }
    }

    function promptFileUpload(folderId) {
      const input = document.createElement('input');
      input.type = 'file';
      input.onchange = async () => {
        const file = input.files[0];
        if (!file) return;
        setStatus('Uploading...');
        await gapi.client.load('drive', 'v3');
        const metadata = {
          name: file.name,
          parents: [folderId]
        };
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
        form.append('file', file);

        fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
          method: 'POST',
          headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
          body: form,
        })
          .then(res => res.json())
          .then(val => {
            if (val && val.name)
              setStatus(`Upload complete: ${val.name}`);
            else
              setStatus("Upload failed: Check Drive API permissions or quota.");
          })
          .catch(e => {
            setStatus(`Upload error: ${e}`);
          });
      };
      input.click();
    }
  </script>
</body>
</html>
